"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const db_host = process.env.DB_HOST;
const db_port = process.env.DB_PORT;
const db_username = process.env.DB_USER;
const db_password = process.env.DB_PASS;
const http = require("http");
let add_or_update_user = (username, password, done, existing_user) => {
    // An object of options to indicate where to post to
    let post_data = {
        name: username,
        password: password,
        roles: [],
        type: 'user'
    };
    if (existing_user) {
        post_data._rev = existing_user._rev;
    }
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var post_options;
    post_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: 'PUT',
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.request(post_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.ok) {
                done();
            }
            else {
                done(response);
            }
        });
    });
    post_req.write(JSON.stringify(post_data));
    post_req.end();
};
function get_user(username, done) {
    basic_method_on_user('GET', username, done);
}
function adduser(username, password, done) {
    add_or_update_user(username, password, done, null);
}
exports.adduser = adduser;
function updateuser(username, newPassword, done) {
    get_user(username, (err, user_object) => {
        if (err) {
            done(err);
        }
        else {
            add_or_update_user(username, newPassword, done, user_object);
        }
    });
}
exports.updateuser = updateuser;
function deleteuser(username, done) {
    get_user(username, (err, user_object) => {
        if (err) {
            done(err);
        }
        else {
            basic_method_on_user('DELETE', username + "?rev=" + user_object._rev, done);
        }
    });
}
exports.deleteuser = deleteuser;
function basic_method_on_user(method_name, username, done) {
    // An object of options to indicate where to post to
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var get_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: method_name,
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.request(get_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.error) {
                done(response);
            }
            else {
                done(null, response);
            }
        });
    });
    post_req.end();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGJ3cmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RhdGFiYXNlL2Rid3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLDZCQUE2QjtBQUU3QixJQUFJLGtCQUFrQixHQUFrQyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLGFBQWE7SUFFNUYsb0RBQW9EO0lBQ3BELElBQUksU0FBUyxHQUErQjtRQUN4QyxJQUFJLEVBQUUsUUFBUTtRQUNkLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLEtBQUssRUFBRSxFQUFFO1FBQ1QsSUFBSSxFQUFFLE1BQU07S0FDZixDQUFDO0lBQ0YsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNoQixTQUFTLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7SUFDeEMsQ0FBQztJQUNELElBQUksaUJBQWlCLEdBQUcsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFdkYsSUFBSSxZQUFrQyxDQUFDO0lBQ3ZDLFlBQVksR0FBRztRQUNYLElBQUksRUFBRSxPQUFPO1FBQ2IsSUFBSSxFQUFFLE9BQU87UUFDYixJQUFJLEVBQUUsMkJBQTJCLEdBQUcsUUFBUTtRQUM1QyxNQUFNLEVBQUUsS0FBSztRQUNiLE9BQU8sRUFBRTtZQUNMLGVBQWUsRUFBRSxRQUFRLEdBQUcsaUJBQWlC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TCxlQUFlLEVBQUUsUUFBUSxHQUFHLGlCQUFpQjtZQUM3QyxRQUFRLEVBQUUsa0JBQWtCO1lBQzVCLGNBQWMsRUFBRSxrQkFBa0I7U0FDckM7S0FDSixDQUFDO0lBRUYscUJBQXFCO0lBQ3JCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLFVBQVMsR0FBRztRQUNqRCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUE7UUFDYixHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hCLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVUsS0FBSztZQUMxQixJQUFJLElBQUksS0FBSyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUU7WUFDVixJQUFJLFFBQVEsR0FBeUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0RCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25CLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3pCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBkYl9ob3N0ID0gcHJvY2Vzcy5lbnYuREJfSE9TVDtcclxuY29uc3QgZGJfcG9ydCA9IHByb2Nlc3MuZW52LkRCX1BPUlQ7XHJcbmNvbnN0IGRiX3VzZXJuYW1lID0gcHJvY2Vzcy5lbnYuREJfVVNFUjtcclxuY29uc3QgZGJfcGFzc3dvcmQgPSBwcm9jZXNzLmVudi5EQl9QQVNTO1xyXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XHJcblxyXG5sZXQgYWRkX29yX3VwZGF0ZV91c2VyIDogZGJ3cmFwcGVyLmFkZF9vcl91cGRhdGVfdXNlciA9ICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUsIGV4aXN0aW5nX3VzZXIpID0+IHtcclxuXHJcbiAgICAvLyBBbiBvYmplY3Qgb2Ygb3B0aW9ucyB0byBpbmRpY2F0ZSB3aGVyZSB0byBwb3N0IHRvXHJcbiAgICBsZXQgcG9zdF9kYXRhIDogZGJ3cmFwcGVyLkl1c2VyX3Bvc3RfZGF0YSA9IHtcclxuICAgICAgICBuYW1lOiB1c2VybmFtZSxcclxuICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsXHJcbiAgICAgICAgcm9sZXM6IFtdLFxyXG4gICAgICAgIHR5cGU6ICd1c2VyJ1xyXG4gICAgfTtcclxuICAgIGlmIChleGlzdGluZ191c2VyKSB7XHJcbiAgICAgICAgcG9zdF9kYXRhLl9yZXYgPSBleGlzdGluZ191c2VyLl9yZXY7XHJcbiAgICB9XHJcbiAgICB2YXIgYmFzZTY0ZW5jb2RlZERhdGEgPSBuZXcgQnVmZmVyKGRiX3VzZXJuYW1lICsgJzonICsgZGJfcGFzc3dvcmQpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuXHJcbiAgICB2YXIgcG9zdF9vcHRpb25zIDogaHR0cC5SZXF1ZXN0T3B0aW9ucztcclxuICAgIHBvc3Rfb3B0aW9ucyA9IHtcclxuICAgICAgICBob3N0OiBkYl9ob3N0LFxyXG4gICAgICAgIHBvcnQ6IGRiX3BvcnQsXHJcbiAgICAgICAgcGF0aDogJy9fdXNlcnMvb3JnLmNvdWNoZGIudXNlcjonICsgdXNlcm5hbWUsXHJcbiAgICAgICAgbWV0aG9kOiAnUFVUJyxcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogJ0Jhc2ljICcgKyBiYXNlNjRlbmNvZGVkRGF0YSxcclxuICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgICAvLyBTZXQgdXAgdGhlIHJlcXVlc3RcclxuICAgIHZhciBwb3N0X3JlcSA9IGh0dHAucmVxdWVzdChwb3N0X29wdGlvbnMsIGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgIHZhciBib2R5ID0gJydcclxuICAgICAgICByZXMuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcclxuICAgICAgICByZXMub24oJ2RhdGEnLCBmdW5jdGlvbiAoY2h1bmspIHtcclxuICAgICAgICAgICAgYm9keSArPSBjaHVuaztcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlc3BvbnNlIDogZGJ3cmFwcGVyLklyZXNwb25zZSA9IEpTT04ucGFyc2UoYm9keSk7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5vaykge1xyXG4gICAgICAgICAgICAgICAgZG9uZSgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9uZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSAgXHJcbiAgICB9KTtcclxuICAgIHBvc3RfcmVxLndyaXRlKEpTT04uc3RyaW5naWZ5KHBvc3RfZGF0YSkpO1xyXG4gICAgcG9zdF9yZXEuZW5kKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldF91c2VyKHVzZXJuYW1lLCBkb25lKSB7XHJcbiAgICBiYXNpY19tZXRob2Rfb25fdXNlcignR0VUJywgdXNlcm5hbWUsIGRvbmUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhZGR1c2VyKHVzZXJuYW1lOnN0cmluZywgcGFzc3dvcmQ6c3RyaW5nLCBkb25lKSB7XHJcbiAgICBhZGRfb3JfdXBkYXRlX3VzZXIodXNlcm5hbWUsIHBhc3N3b3JkLCBkb25lLCBudWxsKTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRldXNlcih1c2VybmFtZTogc3RyaW5nLCBuZXdQYXNzd29yZDpzdHJpbmcsIGRvbmUpIHtcclxuICAgIGdldF91c2VyKHVzZXJuYW1lLCAoZXJyLCB1c2VyX29iamVjdCkgPT4ge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgZG9uZShlcnIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFkZF9vcl91cGRhdGVfdXNlcih1c2VybmFtZSwgbmV3UGFzc3dvcmQsIGRvbmUsIHVzZXJfb2JqZWN0KVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlbGV0ZXVzZXIodXNlcm5hbWU6c3RyaW5nLCBkb25lKSB7XHJcbiAgICBnZXRfdXNlcih1c2VybmFtZSwgKGVyciwgdXNlcl9vYmplY3QpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGRvbmUoZXJyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBiYXNpY19tZXRob2Rfb25fdXNlcignREVMRVRFJywgdXNlcm5hbWUgKyBcIj9yZXY9XCIgKyB1c2VyX29iamVjdC5fcmV2LCBkb25lKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gYmFzaWNfbWV0aG9kX29uX3VzZXIobWV0aG9kX25hbWU6IHN0cmluZywgdXNlcm5hbWU6c3RyaW5nLCBkb25lKSB7XHJcbi8vIEFuIG9iamVjdCBvZiBvcHRpb25zIHRvIGluZGljYXRlIHdoZXJlIHRvIHBvc3QgdG9cclxuICAgIHZhciBiYXNlNjRlbmNvZGVkRGF0YSA9IG5ldyBCdWZmZXIoZGJfdXNlcm5hbWUgKyAnOicgKyBkYl9wYXNzd29yZCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xyXG5cclxuICAgIHZhciBnZXRfb3B0aW9ucyA9IHtcclxuICAgICAgICBob3N0OiBkYl9ob3N0LFxyXG4gICAgICAgIHBvcnQ6IGRiX3BvcnQsXHJcbiAgICAgICAgcGF0aDogJy9fdXNlcnMvb3JnLmNvdWNoZGIudXNlcjonICsgdXNlcm5hbWUsXHJcbiAgICAgICAgbWV0aG9kOiBtZXRob2RfbmFtZSxcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogJ0Jhc2ljICcgKyBiYXNlNjRlbmNvZGVkRGF0YSxcclxuICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0XHJcbiAgICB2YXIgcG9zdF9yZXEgPSBodHRwLnJlcXVlc3QoZ2V0X29wdGlvbnMsIGZ1bmN0aW9uKHJlcykge1xyXG4gICAgICAgIHZhciBib2R5ID0gJydcclxuICAgICAgICByZXMuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcclxuICAgICAgICByZXMub24oJ2RhdGEnLCBmdW5jdGlvbiAoY2h1bmspIHtcclxuICAgICAgICAgICAgYm9keSArPSBjaHVuaztcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlc3BvbnNlIDogZGJ3cmFwcGVyLklyZXNwb25zZSA9IEpTT04ucGFyc2UoYm9keSk7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgZG9uZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkb25lKG51bGwsIHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pICBcclxuICAgIH0pO1xyXG4gICAgcG9zdF9yZXEuZW5kKCk7XHJcbn1cclxuXHJcbmV4cG9ydCB7YWRkdXNlciwgdXBkYXRldXNlciwgZGVsZXRldXNlcn07Il19