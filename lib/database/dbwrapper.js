"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const db_host = process.env.DB_HOST;
const db_port = process.env.DB_PORT;
const db_username = process.env.DB_USER;
const db_password = process.env.DB_PASS;
const http = require("http");
let add_user = (username, password, done, existing_user) => {
    // An object of options to indicate where to post to
    var post_data;
    post_data.name = username;
    post_data.password = password;
    post_data.roles = [];
    post_data.type = 'user';
    if (existing_user) {
        post_data._rev = existing_user._rev;
    }
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var post_options;
    post_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: 'PUT',
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.request(post_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.ok) {
                done();
            }
            else {
                done(response);
            }
        });
    });
    post_req.write(JSON.stringify(post_data));
    post_req.end();
};
function get_user(username, done) {
    // An object of options to indicate where to post to
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var get_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: 'GET',
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.get(get_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.error) {
                done(null, response);
            }
            else {
                done(response);
            }
        });
    });
}
function adduser(username, password, done) {
    get_user(username, (user_object, err) => {
        if (err) {
            add_user(username, password, done, null);
        }
        else {
            add_user(username, password, done, user_object);
        }
    });
}
exports.adduser = adduser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGJ3cmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RhdGFiYXNlL2Rid3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLDZCQUE2QjtBQUU3QixJQUFJLFFBQVEsR0FBd0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxhQUFhO0lBRXhFLG9EQUFvRDtJQUNwRCxJQUFJLFNBQXFDLENBQUM7SUFDMUMsU0FBUyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7SUFDMUIsU0FBUyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDOUIsU0FBUyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7SUFDckIsU0FBUyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7SUFDeEIsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNoQixTQUFTLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7SUFDeEMsQ0FBQztJQUNELElBQUksaUJBQWlCLEdBQUcsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFdkYsSUFBSSxZQUFrQyxDQUFDO0lBQ3ZDLFlBQVksR0FBRztRQUNYLElBQUksRUFBRSxPQUFPO1FBQ2IsSUFBSSxFQUFFLE9BQU87UUFDYixJQUFJLEVBQUUsMkJBQTJCLEdBQUcsUUFBUTtRQUM1QyxNQUFNLEVBQUUs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RSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osUUFBUSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1FBQ25ELENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFFTywwQkFBTyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRiX2hvc3QgPSBwcm9jZXNzLmVudi5EQl9IT1NUO1xyXG5jb25zdCBkYl9wb3J0ID0gcHJvY2Vzcy5lbnYuREJfUE9SVDtcclxuY29uc3QgZGJfdXNlcm5hbWUgPSBwcm9jZXNzLmVudi5EQl9VU0VSO1xyXG5jb25zdCBkYl9wYXNzd29yZCA9IHByb2Nlc3MuZW52LkRCX1BBU1M7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuXHJcbmxldCBhZGRfdXNlciA6IGRid3JhcHBlci5hZGRfdXNlciA9ICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUsIGV4aXN0aW5nX3VzZXIpID0+IHtcclxuXHJcbiAgICAvLyBBbiBvYmplY3Qgb2Ygb3B0aW9ucyB0byBpbmRpY2F0ZSB3aGVyZSB0byBwb3N0IHRvXHJcbiAgICB2YXIgcG9zdF9kYXRhIDogZGJ3cmFwcGVyLkl1c2VyX3Bvc3RfZGF0YTtcclxuICAgIHBvc3RfZGF0YS5uYW1lID0gdXNlcm5hbWU7XHJcbiAgICBwb3N0X2RhdGEucGFzc3dvcmQgPSBwYXNzd29yZDtcclxuICAgIHBvc3RfZGF0YS5yb2xlcyA9IFtdO1xyXG4gICAgcG9zdF9kYXRhLnR5cGUgPSAndXNlcic7XHJcbiAgICBpZiAoZXhpc3RpbmdfdXNlcikge1xyXG4gICAgICAgIHBvc3RfZGF0YS5fcmV2ID0gZXhpc3RpbmdfdXNlci5fcmV2O1xyXG4gICAgfVxyXG4gICAgdmFyIGJhc2U2NGVuY29kZWREYXRhID0gbmV3IEJ1ZmZlcihkYl91c2VybmFtZSArICc6JyArIGRiX3Bhc3N3b3JkKS50b1N0cmluZygnYmFzZTY0Jyk7XHJcblxyXG4gICAgdmFyIHBvc3Rfb3B0aW9ucyA6IGh0dHAuUmVxdWVzdE9wdGlvbnM7XHJcbiAgICBwb3N0X29wdGlvbnMgPSB7XHJcbiAgICAgICAgaG9zdDogZGJfaG9zdCxcclxuICAgICAgICBwb3J0OiBkYl9wb3J0LFxyXG4gICAgICAgIHBhdGg6ICcvX3VzZXJzL29yZy5jb3VjaGRiLnVzZXI6JyArIHVzZXJuYW1lLFxyXG4gICAgICAgIG1ldGhvZDogJ1BVVCcsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6ICdCYXNpYyAnICsgYmFzZTY0ZW5jb2RlZERhdGEsXHJcbiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0XHJcbiAgICB2YXIgcG9zdF9yZXEgPSBodHRwLnJlcXVlc3QocG9zdF9vcHRpb25zLCBmdW5jdGlvbihyZXMpIHtcclxuICAgICAgICB2YXIgYm9keSA9ICcnXHJcbiAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XHJcbiAgICAgICAgcmVzLm9uKCdkYXRhJywgZnVuY3Rpb24gKGNodW5rKSB7XHJcbiAgICAgICAgICAgIGJvZHkgKz0gY2h1bms7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVzLm9uKCdlbmQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZXNwb25zZSA6IGRid3JhcHBlci5JcmVzcG9uc2UgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcclxuICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvbmUocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkgIFxyXG4gICAgfSk7XHJcbiAgICBwb3N0X3JlcS53cml0ZShKU09OLnN0cmluZ2lmeShwb3N0X2RhdGEpKTtcclxuICAgIHBvc3RfcmVxLmVuZCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRfdXNlcih1c2VybmFtZSwgZG9uZSkge1xyXG4vLyBBbiBvYmplY3Qgb2Ygb3B0aW9ucyB0byBpbmRpY2F0ZSB3aGVyZSB0byBwb3N0IHRvXHJcbiAgICB2YXIgYmFzZTY0ZW5jb2RlZERhdGEgPSBuZXcgQnVmZmVyKGRiX3VzZXJuYW1lICsgJzonICsgZGJfcGFzc3dvcmQpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuXHJcbiAgICB2YXIgZ2V0X29wdGlvbnMgPSB7XHJcbiAgICAgICAgaG9zdDogZGJfaG9zdCxcclxuICAgICAgICBwb3J0OiBkYl9wb3J0LFxyXG4gICAgICAgIHBhdGg6ICcvX3VzZXJzL29yZy5jb3VjaGRiLnVzZXI6JyArIHVzZXJuYW1lLFxyXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6ICdCYXNpYyAnICsgYmFzZTY0ZW5jb2RlZERhdGEsXHJcbiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0XHJcbiAgICB2YXIgcG9zdF9yZXEgPSBodHRwLmdldChnZXRfb3B0aW9ucywgZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSAnJ1xyXG4gICAgICAgIHJlcy5zZXRFbmNvZGluZygndXRmOCcpO1xyXG4gICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xyXG4gICAgICAgICAgICBib2R5ICs9IGNodW5rO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcy5vbignZW5kJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVzcG9uc2UgOiBkYndyYXBwZXIuSXJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBkb25lKG51bGwsIHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvbmUocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkgIFxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFkZHVzZXIodXNlcm5hbWU6c3RyaW5nLCBwYXNzd29yZDpzdHJpbmcsIGRvbmUpIHtcclxuICAgIGdldF91c2VyKHVzZXJuYW1lLCAodXNlcl9vYmplY3QsIGVycikgPT4ge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgYWRkX3VzZXIodXNlcm5hbWUsIHBhc3N3b3JkLCBkb25lLCBudWxsKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhZGRfdXNlcih1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUsIHVzZXJfb2JqZWN0KVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbn1cclxuXHJcbmV4cG9ydCB7YWRkdXNlcn07Il19