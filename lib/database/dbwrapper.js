"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const db_host = process.env.DB_HOST;
const db_port = process.env.DB_PORT;
const db_username = process.env.DB_USER;
const db_password = process.env.DB_PASS;
const http = require("http");
function adduser(username, password, done) {
    add_or_update_user(username, password, err => {
        if (err) {
            done(err);
        }
        else {
            create_database_for_user(username, done);
        }
    }, null);
}
exports.adduser = adduser;
function updateuser(username, newPassword, done) {
    get_user(username, (err, user_object) => {
        if (err) {
            done(err);
        }
        else {
            add_or_update_user(username, newPassword, done, user_object);
        }
    });
}
exports.updateuser = updateuser;
function deleteuser(username, done) {
    get_user(username, (err, user_object) => {
        if (err) {
            done(err);
        }
        else {
            basic_method_on_user('DELETE', username + "?rev=" + user_object._rev, err => {
                if (err) {
                    done(err);
                }
                else {
                    delete_database_for_user(username, done);
                }
            });
        }
    });
}
exports.deleteuser = deleteuser;
function generic_db_request(request_method, path, request_body, responseCallback) {
    var base64encodedAuth = new Buffer(db_username + ':' + db_password).toString('base64');
    var request_options;
    request_options = {
        host: db_host,
        port: db_port,
        path: path,
        method: request_method,
        headers: {
            'Authorization': 'Basic ' + base64encodedAuth,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var req = http.request(request_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            responseCallback(response);
        });
    });
    if (request_body) {
        req.write(JSON.stringify(request_body));
    }
    req.end();
}
let add_or_update_user = (username, password, done, existing_user) => {
    // An object of options to indicate where to post to
    let post_data = {
        name: username,
        password: password,
        roles: [],
        type: 'user'
    };
    if (existing_user) {
        post_data._rev = existing_user._rev;
    }
    generic_db_request('PUT', '/_users/org.couchdb.user:' + username, post_data, data => {
        if (data.ok) {
            done();
        }
        else {
            done(data);
        }
    });
};
function get_user(username, done) {
    basic_method_on_user('GET', username, done);
}
function basic_method_on_user(method_name, username, done) {
    // An object of options to indicate where to post to
    generic_db_request(method_name, '/_users/org.couchdb.user:' + username, null, data => {
        if (data.error) {
            done(new Error(JSON.stringify(data)));
        }
        else {
            done(null, data);
        }
    });
}
function create_database_for_user(username, done) {
    // Request to create database with the user having member access
    // The user (app) will then be able to query the API directly to access the database, with permission for this database only
    // PUT /dbname {id: "id", name: "name"} creates the database
    // PUT /dbname/_security {admins: {names: [], roles: []}, {members: {names: ["username"], roles: []}} adds the user
    let dbname = dbname_for_user(username);
    let create_params = {
        id: dbname,
        name: dbname
    };
    let security_params = {
        admins: {
            names: [],
            roles: []
        },
        members: {
            names: [username],
            roles: []
        }
    };
    generic_db_request('PUT', '/' + dbname, create_params, data => {
        if (data.error) {
            done(data);
        }
        else {
            generic_db_request('PUT', '/' + dbname + '/_security', security_params, data => {
                if (data.error) {
                    done(new Error(JSON.stringify(data)));
                }
                else {
                    done(null, data);
                }
            });
        }
    });
}
function delete_database_for_user(username, done) {
    generic_db_request('DELETE', '/' + dbname_for_user(username), null, data => {
        if (data.error) {
            done(new Error(JSON.stringify(data)));
        }
        else {
            done(null, data);
        }
    });
}
function dbname_for_user(username) {
    return 'pairlearn_' + username;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGJ3cmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RhdGFiYXNlL2Rid3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLDZCQUE2QjtBQUU3QixpQkFBaUIsUUFBZSxFQUFFLFFBQWUsRUFBRSxJQUFJO0lBQ25ELGtCQUFrQixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBRztRQUN0QyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osd0JBQXdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdDLENBQUM7SUFDTCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFFYixDQUFDO0FBb0pPLDBCQUFPO0FBbEpmLG9CQUFvQixRQUFnQixFQUFFLFdBQWtCLEVBQUUsSUFBSTtJQUMxRCxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLFdBQVc7UUFDaEMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNkLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1FBQ2hFLENBQUM7SUFDTCxDQUFDLENBQUMs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QUNyQixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDO0FBRUQseUJBQXlCLFFBQWdCO0lBQ3JDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO0FBQ25DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBkYl9ob3N0ID0gcHJvY2Vzcy5lbnYuREJfSE9TVDtcclxuY29uc3QgZGJfcG9ydCA9IHByb2Nlc3MuZW52LkRCX1BPUlQ7XHJcbmNvbnN0IGRiX3VzZXJuYW1lID0gcHJvY2Vzcy5lbnYuREJfVVNFUjtcclxuY29uc3QgZGJfcGFzc3dvcmQgPSBwcm9jZXNzLmVudi5EQl9QQVNTO1xyXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XHJcblxyXG5mdW5jdGlvbiBhZGR1c2VyKHVzZXJuYW1lOnN0cmluZywgcGFzc3dvcmQ6c3RyaW5nLCBkb25lKSA6IHZvaWQge1xyXG4gICAgYWRkX29yX3VwZGF0ZV91c2VyKHVzZXJuYW1lLCBwYXNzd29yZCwgZXJyID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGRvbmUoZXJyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjcmVhdGVfZGF0YWJhc2VfZm9yX3VzZXIodXNlcm5hbWUsIGRvbmUpO1xyXG4gICAgICAgIH1cclxuICAgIH0sIG51bGwpO1xyXG4gICAgXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZXVzZXIodXNlcm5hbWU6IHN0cmluZywgbmV3UGFzc3dvcmQ6c3RyaW5nLCBkb25lKSA6IHZvaWQge1xyXG4gICAgZ2V0X3VzZXIodXNlcm5hbWUsIChlcnIsIHVzZXJfb2JqZWN0KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICBkb25lKGVycik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkX29yX3VwZGF0ZV91c2VyKHVzZXJuYW1lLCBuZXdQYXNzd29yZCwgZG9uZSwgdXNlcl9vYmplY3QpXHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gZGVsZXRldXNlcih1c2VybmFtZTpzdHJpbmcsIGRvbmUpIDogdm9pZCB7XHJcbiAgICBnZXRfdXNlcih1c2VybmFtZSwgKGVyciwgdXNlcl9vYmplY3QpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGRvbmUoZXJyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBiYXNpY19tZXRob2Rfb25fdXNlcignREVMRVRFJywgdXNlcm5hbWUgKyBcIj9yZXY9XCIgKyB1c2VyX29iamVjdC5fcmV2LCBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlX2RhdGFiYXNlX2Zvcl91c2VyKHVzZXJuYW1lLCBkb25lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyaWNfZGJfcmVxdWVzdChyZXF1ZXN0X21ldGhvZDogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIHJlcXVlc3RfYm9keTogb2JqZWN0LCByZXNwb25zZUNhbGxiYWNrKSA6IHZvaWQge1xyXG5cclxuICAgIHZhciBiYXNlNjRlbmNvZGVkQXV0aCA9IG5ldyBCdWZmZXIoZGJfdXNlcm5hbWUgKyAnOicgKyBkYl9wYXNzd29yZCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xyXG5cclxuICAgIHZhciByZXF1ZXN0X29wdGlvbnMgOiBodHRwLlJlcXVlc3RPcHRpb25zO1xyXG4gICAgcmVxdWVzdF9vcHRpb25zID0ge1xyXG4gICAgICAgIGhvc3Q6IGRiX2hvc3QsXHJcbiAgICAgICAgcG9ydDogZGJfcG9ydCxcclxuICAgICAgICBwYXRoOiBwYXRoLFxyXG4gICAgICAgIG1ldGhvZDogcmVxdWVzdF9tZXRob2QsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6ICdCYXNpYyAnICsgYmFzZTY0ZW5jb2RlZEF1dGgsXHJcbiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0XHJcbiAgICB2YXIgcmVxID0gaHR0cC5yZXF1ZXN0KHJlcXVlc3Rfb3B0aW9ucywgZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSAnJ1xyXG4gICAgICAgIHJlcy5zZXRFbmNvZGluZygndXRmOCcpO1xyXG4gICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xyXG4gICAgICAgICAgICBib2R5ICs9IGNodW5rO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcy5vbignZW5kJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVzcG9uc2UgOiBkYndyYXBwZXIuSXJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcclxuICAgICAgICAgICAgcmVzcG9uc2VDYWxsYmFjayhyZXNwb25zZSk7XHJcbiAgICAgICAgfSkgIFxyXG4gICAgfSk7XHJcbiAgICBpZiAocmVxdWVzdF9ib2R5KSB7XHJcbiAgICAgICAgcmVxLndyaXRlKEpTT04uc3RyaW5naWZ5KHJlcXVlc3RfYm9keSkpO1xyXG4gICAgfVxyXG4gICAgcmVxLmVuZCgpO1xyXG59XHJcblxyXG5sZXQgYWRkX29yX3VwZGF0ZV91c2VyIDogZGJ3cmFwcGVyLmFkZF9vcl91cGRhdGVfdXNlciA9ICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUsIGV4aXN0aW5nX3VzZXIpID0+IHtcclxuXHJcbiAgICAvLyBBbiBvYmplY3Qgb2Ygb3B0aW9ucyB0byBpbmRpY2F0ZSB3aGVyZSB0byBwb3N0IHRvXHJcbiAgICBsZXQgcG9zdF9kYXRhIDogZGJ3cmFwcGVyLkl1c2VyX3Bvc3RfZGF0YSA9IHtcclxuICAgICAgICBuYW1lOiB1c2VybmFtZSxcclxuICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsXHJcbiAgICAgICAgcm9sZXM6IFtdLFxyXG4gICAgICAgIHR5cGU6ICd1c2VyJ1xyXG4gICAgfTtcclxuICAgIGlmIChleGlzdGluZ191c2VyKSB7XHJcbiAgICAgICAgcG9zdF9kYXRhLl9yZXYgPSBleGlzdGluZ191c2VyLl9yZXY7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdlbmVyaWNfZGJfcmVxdWVzdCgnUFVUJywgJy9fdXNlcnMvb3JnLmNvdWNoZGIudXNlcjonICsgdXNlcm5hbWUsIHBvc3RfZGF0YSwgZGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEub2spIHtcclxuICAgICAgICAgICAgZG9uZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGRvbmUoZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0X3VzZXIodXNlcm5hbWUsIGRvbmUpIDogdm9pZCB7XHJcbiAgICBiYXNpY19tZXRob2Rfb25fdXNlcignR0VUJywgdXNlcm5hbWUsIGRvbmUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiYXNpY19tZXRob2Rfb25fdXNlcihtZXRob2RfbmFtZTogc3RyaW5nLCB1c2VybmFtZTpzdHJpbmcsIGRvbmUpIDogdm9pZCB7XHJcbi8vIEFuIG9iamVjdCBvZiBvcHRpb25zIHRvIGluZGljYXRlIHdoZXJlIHRvIHBvc3QgdG9cclxuICAgIGdlbmVyaWNfZGJfcmVxdWVzdChtZXRob2RfbmFtZSwgJy9fdXNlcnMvb3JnLmNvdWNoZGIudXNlcjonICsgdXNlcm5hbWUsIG51bGwsIGRhdGEgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XHJcbiAgICAgICAgICAgIGRvbmUobmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZG9uZShudWxsLCBkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlX2RhdGFiYXNlX2Zvcl91c2VyKHVzZXJuYW1lOnN0cmluZywgZG9uZSkgOiB2b2lkIHtcclxuICAgIC8vIFJlcXVlc3QgdG8gY3JlYXRlIGRhdGFiYXNlIHdpdGggdGhlIHVzZXIgaGF2aW5nIG1lbWJlciBhY2Nlc3NcclxuICAgIC8vIFRoZSB1c2VyIChhcHApIHdpbGwgdGhlbiBiZSBhYmxlIHRvIHF1ZXJ5IHRoZSBBUEkgZGlyZWN0bHkgdG8gYWNjZXNzIHRoZSBkYXRhYmFzZSwgd2l0aCBwZXJtaXNzaW9uIGZvciB0aGlzIGRhdGFiYXNlIG9ubHlcclxuICAgIC8vIFBVVCAvZGJuYW1lIHtpZDogXCJpZFwiLCBuYW1lOiBcIm5hbWVcIn0gY3JlYXRlcyB0aGUgZGF0YWJhc2VcclxuICAgIC8vIFBVVCAvZGJuYW1lL19zZWN1cml0eSB7YWRtaW5zOiB7bmFtZXM6IFtdLCByb2xlczogW119LCB7bWVtYmVyczoge25hbWVzOiBbXCJ1c2VybmFtZVwiXSwgcm9sZXM6IFtdfX0gYWRkcyB0aGUgdXNlclxyXG4gICAgbGV0IGRibmFtZTogc3RyaW5nID0gZGJuYW1lX2Zvcl91c2VyKHVzZXJuYW1lKTtcclxuICAgIGxldCBjcmVhdGVfcGFyYW1zID0ge1xyXG4gICAgICAgIGlkOiBkYm5hbWUsXHJcbiAgICAgICAgbmFtZTogZGJuYW1lXHJcbiAgICB9XHJcbiAgICBsZXQgc2VjdXJpdHlfcGFyYW1zID0ge1xyXG4gICAgICAgIGFkbWluczoge1xyXG4gICAgICAgICAgICBuYW1lczogW10sXHJcbiAgICAgICAgICAgIHJvbGVzOiBbXVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWVtYmVyczoge1xyXG4gICAgICAgICAgICBuYW1lczogW3VzZXJuYW1lXSxcclxuICAgICAgICAgICAgcm9sZXM6IFtdXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2VuZXJpY19kYl9yZXF1ZXN0KCdQVVQnLCAnLycgKyBkYm5hbWUsIGNyZWF0ZV9wYXJhbXMsIGRhdGEgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XHJcbiAgICAgICAgICAgIGRvbmUoZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZ2VuZXJpY19kYl9yZXF1ZXN0KCdQVVQnLCAnLycgKyBkYm5hbWUgKyAnL19zZWN1cml0eScsIHNlY3VyaXR5X3BhcmFtcywgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbmUobmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuZnVuY3Rpb24gZGVsZXRlX2RhdGFiYXNlX2Zvcl91c2VyKHVzZXJuYW1lOiBzdHJpbmcsIGRvbmUpIDogdm9pZCB7XHJcbiAgICBnZW5lcmljX2RiX3JlcXVlc3QoJ0RFTEVURScsICcvJyArIGRibmFtZV9mb3JfdXNlcih1c2VybmFtZSksIG51bGwsIGRhdGEgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XHJcbiAgICAgICAgICAgIGRvbmUobmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZG9uZShudWxsLCBkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBkYm5hbWVfZm9yX3VzZXIodXNlcm5hbWU6IHN0cmluZykgOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuICdwYWlybGVhcm5fJyArIHVzZXJuYW1lO1xyXG59XHJcblxyXG5leHBvcnQge2FkZHVzZXIsIHVwZGF0ZXVzZXIsIGRlbGV0ZXVzZXJ9OyJdfQ==