"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const db_host = process.env.DB_HOST;
const db_port = process.env.DB_PORT;
const db_username = process.env.DB_USER;
const db_password = process.env.DB_PASS;
const http = require("http");
function add_user(username, password, done, existing_user) {
    // An object of options to indicate where to post to
    var post_data;
    post_data.name = username;
    post_data.password = password;
    post_data.roles = [];
    post_data.type = 'user';
    if (existing_user) {
        post_data._rev = existing_user._rev;
    }
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var post_options;
    post_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: 'PUT',
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.request(post_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.ok) {
                done();
            }
            else {
                done(response);
            }
        });
    });
    post_req.write(JSON.stringify(post_data));
    post_req.end();
}
function get_user(username, done) {
    // An object of options to indicate where to post to
    var base64encodedData = new Buffer(db_username + ':' + db_password).toString('base64');
    var get_options = {
        host: db_host,
        port: db_port,
        path: '/_users/org.couchdb.user:' + username,
        method: 'GET',
        headers: {
            'Authorization': 'Basic ' + base64encodedData,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };
    // Set up the request
    var post_req = http.get(get_options, function (res) {
        var body = '';
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            body += chunk;
        });
        res.on('end', function () {
            var response = JSON.parse(body);
            if (response.error) {
                done(null, response);
            }
            else {
                done(response);
            }
        });
    });
}
function adduser(username, password, done) {
    get_user(username, (user_object, err) => {
        if (err) {
            add_user(username, password, done, null);
        }
        else {
            add_user(username, password, done, user_object);
        }
    });
}
exports.adduser = adduser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGJ3cmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RhdGFiYXNlL2Rid3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3BDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ3hDLDZCQUE2QjtBQWM3QixrQkFBa0IsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsYUFBYTtJQUVyRCxvREFBb0Q7SUFDcEQsSUFBSSxTQUEyQixDQUFDO0lBQ2hDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO0lBQzFCLFNBQVMsQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzlCLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLFNBQVMsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDO0lBQ3hCLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDaEIsU0FBUyxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxJQUFJLGlCQUFpQixHQUFHLElBQUksTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLEdBQUcsV0FBVyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXZGLElBQUksWUFBa0MsQ0FBQztJQUN2QyxZQUFZLEdBQUc7UUFDWCxJQUFJLEVBQUUsT0FBTztRQUNiLElBQUksRUFBRSxPQUFPO1FBQ2IsSUFBSSxFQUFFLDJCQUEyQixHQUFHLFFBQVE7UUFDNUMsTUFBTSxFQUFFLEtBQUs7UUFDYixP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QUFDLENBQUM7UUFDN0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osUUFBUSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1FBQ25ELENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFFTywwQkFBTyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRiX2hvc3QgPSBwcm9jZXNzLmVudi5EQl9IT1NUO1xyXG5jb25zdCBkYl9wb3J0ID0gcHJvY2Vzcy5lbnYuREJfUE9SVDtcclxuY29uc3QgZGJfdXNlcm5hbWUgPSBwcm9jZXNzLmVudi5EQl9VU0VSO1xyXG5jb25zdCBkYl9wYXNzd29yZCA9IHByb2Nlc3MuZW52LkRCX1BBU1M7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcclxuXHJcbmludGVyZmFjZSBJdXNlcl9wb3N0X2RhdGEge1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgcGFzc3dvcmQ6IHN0cmluZztcclxuICAgIHJvbGVzOiBBcnJheTxzdHJpbmc+O1xyXG4gICAgdHlwZTogc3RyaW5nO1xyXG4gICAgX3Jldjogc3RyaW5nO1xyXG59XHJcbmludGVyZmFjZSBJcmVzcG9uc2UgZXh0ZW5kcyBPYmplY3Qge1xyXG4gICAgb2s6IHN0cmluZztcclxuICAgIGVycm9yOiBFcnJvcjtcclxufVxyXG5cclxuZnVuY3Rpb24gYWRkX3VzZXIodXNlcm5hbWUsIHBhc3N3b3JkLCBkb25lLCBleGlzdGluZ191c2VyKSB7XHJcblxyXG4gICAgLy8gQW4gb2JqZWN0IG9mIG9wdGlvbnMgdG8gaW5kaWNhdGUgd2hlcmUgdG8gcG9zdCB0b1xyXG4gICAgdmFyIHBvc3RfZGF0YSA6IEl1c2VyX3Bvc3RfZGF0YTtcclxuICAgIHBvc3RfZGF0YS5uYW1lID0gdXNlcm5hbWU7XHJcbiAgICBwb3N0X2RhdGEucGFzc3dvcmQgPSBwYXNzd29yZDtcclxuICAgIHBvc3RfZGF0YS5yb2xlcyA9IFtdO1xyXG4gICAgcG9zdF9kYXRhLnR5cGUgPSAndXNlcic7XHJcbiAgICBpZiAoZXhpc3RpbmdfdXNlcikge1xyXG4gICAgICAgIHBvc3RfZGF0YS5fcmV2ID0gZXhpc3RpbmdfdXNlci5fcmV2O1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBiYXNlNjRlbmNvZGVkRGF0YSA9IG5ldyBCdWZmZXIoZGJfdXNlcm5hbWUgKyAnOicgKyBkYl9wYXNzd29yZCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xyXG5cclxuICAgIHZhciBwb3N0X29wdGlvbnMgOiBodHRwLlJlcXVlc3RPcHRpb25zO1xyXG4gICAgcG9zdF9vcHRpb25zID0ge1xyXG4gICAgICAgIGhvc3Q6IGRiX2hvc3QsXHJcbiAgICAgICAgcG9ydDogZGJfcG9ydCxcclxuICAgICAgICBwYXRoOiAnL191c2Vycy9vcmcuY291Y2hkYi51c2VyOicgKyB1c2VybmFtZSxcclxuICAgICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiAnQmFzaWMgJyArIGJhc2U2NGVuY29kZWREYXRhLFxyXG4gICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAgIC8vIFNldCB1cCB0aGUgcmVxdWVzdFxyXG4gICAgdmFyIHBvc3RfcmVxID0gaHR0cC5yZXF1ZXN0KHBvc3Rfb3B0aW9ucywgZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSAnJ1xyXG4gICAgICAgIHJlcy5zZXRFbmNvZGluZygndXRmOCcpO1xyXG4gICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xyXG4gICAgICAgICAgICBib2R5ICs9IGNodW5rO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcy5vbignZW5kJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVzcG9uc2UgOiBJcmVzcG9uc2UgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcclxuICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvbmUocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkgIFxyXG4gICAgfSk7XHJcbiAgICBwb3N0X3JlcS53cml0ZShKU09OLnN0cmluZ2lmeShwb3N0X2RhdGEpKTtcclxuICAgIHBvc3RfcmVxLmVuZCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRfdXNlcih1c2VybmFtZSwgZG9uZSkge1xyXG4vLyBBbiBvYmplY3Qgb2Ygb3B0aW9ucyB0byBpbmRpY2F0ZSB3aGVyZSB0byBwb3N0IHRvXHJcbiAgICB2YXIgYmFzZTY0ZW5jb2RlZERhdGEgPSBuZXcgQnVmZmVyKGRiX3VzZXJuYW1lICsgJzonICsgZGJfcGFzc3dvcmQpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuXHJcbiAgICB2YXIgZ2V0X29wdGlvbnMgPSB7XHJcbiAgICAgICAgaG9zdDogZGJfaG9zdCxcclxuICAgICAgICBwb3J0OiBkYl9wb3J0LFxyXG4gICAgICAgIHBhdGg6ICcvX3VzZXJzL29yZy5jb3VjaGRiLnVzZXI6JyArIHVzZXJuYW1lLFxyXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6ICdCYXNpYyAnICsgYmFzZTY0ZW5jb2RlZERhdGEsXHJcbiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0XHJcbiAgICB2YXIgcG9zdF9yZXEgPSBodHRwLmdldChnZXRfb3B0aW9ucywgZnVuY3Rpb24ocmVzKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSAnJ1xyXG4gICAgICAgIHJlcy5zZXRFbmNvZGluZygndXRmOCcpO1xyXG4gICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuaykge1xyXG4gICAgICAgICAgICBib2R5ICs9IGNodW5rO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcy5vbignZW5kJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVzcG9uc2UgOiBJcmVzcG9uc2UgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGRvbmUobnVsbCwgcmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9uZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSAgXHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gYWRkdXNlcih1c2VybmFtZTpzdHJpbmcsIHBhc3N3b3JkOnN0cmluZywgZG9uZSkge1xyXG4gICAgZ2V0X3VzZXIodXNlcm5hbWUsICh1c2VyX29iamVjdCwgZXJyKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICBhZGRfdXNlcih1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUsIG51bGwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFkZF91c2VyKHVzZXJuYW1lLCBwYXNzd29yZCwgZG9uZSwgdXNlcl9vYmplY3QpXHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufVxyXG5cclxuZXhwb3J0IHthZGR1c2VyfTsiXX0=